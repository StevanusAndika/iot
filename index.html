<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Face Recognition + ESP32 Camera</title>
  <link rel="stylesheet" href="style/style.css">
</head>

<body>
  <div class="card">
    <h2>ğŸ­ Face Recognition â€” ESP32 Camera Integration <span class="pill">LBP + Cosine</span></h2>

    <div class="section">
      <div class="grid">
        <div>
          <label>ğŸ“· Pilih Sumber Kamera</label>
          <select id="cameraSource">
            <option value="webcam">Webcam Browser</option>
            <option value="esp32" selected>ESP32 Camera</option>
          </select>
        </div>
        <div>
          <label>ğŸ“ Ukuran Canvas</label>
          <select id="size">
            <option value="320x240">320Ã—240</option>
            <option value="480x360">480Ã—360</option>
            <option value="640x480" selected>640Ã—480</option>
          </select>
        </div>
        <div>
          <label>âš¡ Process every N frames</label>
          <select id="nth">
            <option value="1">N=1</option>
            <option value="2" selected>N=2</option>
            <option value="3">N=3</option>
            <option value="4">N=4</option>
          </select>
        </div>
        <div class="row">
          <button id="start" disabled>ğŸš€ Start</button>
          <button id="stop" class="secondary" disabled>ğŸ›‘ Stop</button>
          <label style="display:flex;gap:6px;align-items:center;color:#9fb0c9">
            <input type="checkbox" id="showVideo"> ğŸ‘€ Preview
          </label>
        </div>
      </div>

      <div id="esp32Config" style="margin-top:15px;padding:15px;background:rgba(59,130,246,0.1);border-radius:8px;">
        <div class="row">
          <div style="flex:1">
            <label>ğŸ”— URL ESP32 Camera</label>
            <input id="espUrl" placeholder="http://192.168.4.1" value="http://192.168.4.1">
          </div>
          <div style="min-width:120px">
            <label>ğŸ”‘ API Key</label>
            <input id="espKey" placeholder="rahasiaku123" value="rahasiaku123">
          </div>
          <div class="row">
            <button id="testConnection" class="success">ğŸ” Test Connection</button>
            <div id="connectionStatus" class="status-disconnected">âŒ Not Connected</div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAMBAHAN: Local Storage Controls -->
    <div class="section">
      <h3>ğŸ’¾ Local Storage Management</h3>
      <p class="muted" style="margin-bottom:10px;">
        Kelola data wajah di local storage browser
      </p>

      <div class="storage-controls">
        <div style="flex:1">
          <label>ğŸ“ Nama untuk Simpan Manual</label>
          <input id="manualName" placeholder="Masukkan nama untuk simpan manual">
        </div>
        <div class="row" style="margin-top:20px;width:100%;">
          <button id="saveCurrentFace" class="success" disabled>ğŸ’¾ Simpan Wajah Sekarang</button>
          <button id="getLocalData" class="secondary">ğŸ“± Lihat Data Lokal</button>
          <button id="clearLocalData" class="error">ğŸ—‘ï¸ Hapus Semua Data Lokal</button>
          <button id="exportLocalData" class="secondary">ğŸ“¤ Export ke File</button>
          <label class="secondary"
            style="padding:10px 16px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;background:#334155">
            ğŸ“¥ Import dari File<input id="importLocalData" type="file" accept="application/json" style="display:none">
          </label>
        </div>
      </div>

      <div id="localStorageStatus"
        style="display:none;margin-top:10px;padding:10px;border-radius:8px;background:rgba(59,130,246,0.1);color:var(--text);font-size:13px">
        Status local storage akan muncul di sini
      </div>
    </div>

    <!-- TAMBAHAN: Cloudflare Storage Controls -->
    <div class="section">
      <h3>â˜ï¸ Cloudflare D1 Database Storage</h3>
      <p class="muted" style="margin-bottom:10px;">
        Sync data antara local storage dan Cloudflare D1 Database
      </p>

      <div class="storage-controls">
        <div style="flex:1">
          <label>ğŸ”— Worker URL (Cloudflare)</label>
          <input id="cfWorkerUrl" placeholder="https://your-worker.your-subdomain.workers.dev" value="">
        </div>
        <div style="min-width:120px">
          <label>ğŸ”‘ API Token</label>
          <input id="cfApiToken" placeholder="your-api-token" value="" type="password">
        </div>
        <div class="row" style="margin-top:20px;width:100%;">
          <button id="getCloudData" class="success">â˜ï¸ Ambil Data dari Cloud</button>
          <button id="syncToCloud" class="success">ğŸ“¤ Sync ke Cloud</button>
          <button id="loadFromCloud" class="secondary">ğŸ“¥ Load dari Cloud ke Lokal</button>
          <button id="testCloudConnection" class="success">ğŸ” Test Koneksi</button>
        </div>
      </div>

      <div id="cloudStatus" style="display:none;" class="storage-status">
        Cloudflare connection status will appear here
      </div>
    </div>

    <div class="section">
      <div class="row">
        <div style="min-width:200px">
          <label>ğŸ‘¤ Nama untuk Enroll</label>
          <input id="name" placeholder="mis: Sismadi">
        </div>
        <div style="min-width:120px">
          <label>ğŸ“Š Sample Count</label>
          <select id="samples">
            <option>10</option>
            <option>15</option>
            <option selected>20</option>
            <option>30</option>
          </select>
        </div>
        <div style="min-width:150px">
          <label>ğŸšï¸ Threshold Cosine</label>
          <input id="th" value="0.90" type="number" step="0.01" min="0.5" max="1.0">
        </div>
        <div class="row">
          <button id="enroll" class="secondary" disabled>ğŸ“¸ Enroll Face (Otomatis)</button>
          <button id="exportDb" class="secondary">ğŸ“¤ Export JSON</button>
          <div id="dbStatus"
            style="padding:10px 16px;border-radius:10px;background:rgba(59,130,246,0.1);color:var(--text);font-size:14px">
            Data: 0 wajah
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <div style="min-width:180px">
          <label>â±ï¸ Auto-OFF (detik)</label>
          <input id="espOff" value="5" type="number" min="1" max="60">
        </div>
        <div class="row">
          <button id="testOn" class="success">ğŸ’¡ Test LED ON</button>
          <button id="testOff" class="secondary">ğŸ”Œ Test LED OFF</button>
          <label style="display:flex;gap:6px;align-items:center;color:#9fb0c9">
            <input type="checkbox" id="autoTrigger" checked> ğŸ¤– Auto LED saat Verified
          </label>
        </div>
      </div>
    </div>

    <p class="muted" id="status">â³ Status: memuat OpenCV (WASM)â€¦</p>

    <div class="cam-source">
      <video id="video" playsinline autoplay muted></video>
      <canvas id="canvas" width="640" height="480"></canvas>
    </div>

    <p class="muted" style="margin-top:12px">
      ğŸ’¡ <strong>Tips:</strong> Enroll wajah di pencahayaan baik dengan beberapa pose.
      Pastikan ESP32 dan komputer dalam jaringan WiFi yang sama (ESP32-Camera-AP).
    </p>

    <pre id="log" class="muted">Log akan muncul di sini...</pre>

    <div class="section" style="margin-top:20px;">
      <h3>ğŸ“º Video Tutorial / Demo</h3>
      <div class="video-container"
        style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
        <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
          src="https://www.youtube.com/embed/Z7Uz4THyW4w?si=z0BZ_-Q1cBjW8I0k" title="YouTube video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
        </iframe>
      </div>
    </div>
  </div>


  <footer
    style="margin-top: 40px; padding: 20px; text-align: center; color: #9fb0c9; font-size: 14px; border-top: 1px solid rgba(255, 255, 255, 0.05); opacity: 0.8;">
    <p>&copy; <span id="currentYear"></span> <a href="https://github.com/StevanusAndika" target="_blank"
        style="color: #3b82f6; text-decoration: none; font-weight: 500; transition: color 0.3s;"
        onmouseover="this.style.color='#60a5fa'" onmouseout="this.style.color='#3b82f6'">Stevanus Andika</a>. All rights
      reserved.</p>
  </footer>

  <script>
    document.getElementById('currentYear').textContent = new Date().getFullYear();
  </script>

  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
  <script src="js/script.js"></script>
</body>

</html>